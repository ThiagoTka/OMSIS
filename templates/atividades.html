<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Atividades - {{ projeto.nome }} / {{ fase.nome }} / {{ cenario.cenario }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="page-container">

        <div class="page-header">
            <h1>Atividades - {{ projeto.nome }} / {{ fase.nome }} / {{ cenario.cenario }}</h1>

            <div class="user-bar">
                <a href="{{ url_for('cenarios_por_fase', projeto_id=projeto.id, fase_id=fase.id) }}">← Voltar para Cenários</a>
                <span><strong>Logado como:</strong> {{ usuario_atual }}</span>
            </div>

            {% with messages = get_flashed_messages() %}
            {% if messages %}
                {% for message in messages %}
                    <div class="alert">{{ message }}</div>
                {% endfor %}
            {% endif %}
            {% endwith %}

            <h3>Adicionar Atividade</h3>

            <form method="POST" class="create-form">
                <input type="number" name="numero_sequencial" placeholder="Seq" required>
                <input type="text" name="descricao" placeholder="Descrição" required>
                <select name="responsavel" required>
                    <option value="" disabled selected>Responsável</option>
                    {% for u in usuarios %}
                    <option value="{{ u.username }}">{{ u.username }}</option>
                    {% endfor %}
                </select>
                <button type="submit">Adicionar</button>
            </form>
        </div>

        <table>
            <tr>
                <th>Seq</th>
                <th>Atividade</th>
                <th>Responsável</th>
                <th>Liberada em</th>
                <th>Concluída em</th>
                <th>Ação</th>
            </tr>
            {% for atv in atividades %}
            <tr class="{% if not atv.data_liberacao %}row-disabled{% endif %}">
                <td>{{ atv.numero_sequencial }}</td>
                <td>{{ atv.descricao }}</td>
                <td>{{ atv.responsavel }}</td>
                <td>
                    {{ atv.data_liberacao.strftime('%d/%m %H:%M') if atv.data_liberacao else 'Aguardando anterior' }}
                </td>
                <td>
                    {% if atv.data_conclusao %}
                        <span class="status-success">
                            {{ atv.data_conclusao.strftime('%d/%m %H:%M') }}
                        </span>
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    {% if not atv.data_conclusao %}
                        <form action="/concluir/{{ atv.id }}" method="POST" style="display:inline-block;">
                            <input type="hidden" name="usuario_atual" value="{{ usuario_atual }}">
                            <button
                                type="submit"
                                {% if not atv.data_liberacao or atv.responsavel != usuario_atual %}disabled{% endif %}
                            >
                                Concluir
                            </button>
                        </form>
                    {% else %}
                        <span class="status-success">Concluído</span>
                    {% endif %}

                    <a href="#edit-{{ atv.id }}" style="margin-left:6px;">
                        <button type="button">Editar</button>
                    </a>

                    <form action="/atividades/{{ atv.id }}/delete" method="POST" style="display:inline-block; margin-left:6px;">
                        <button class="btn-danger" type="submit"
                            onclick="return confirm('Excluir esta atividade?')">
                            Excluir
                        </button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </table>

        <!-- Modais de Edição -->
        {% for atv in atividades %}
        <div id="edit-{{ atv.id }}" class="modal">
            <div class="modal-content">
                <a href="#" class="close">&times;</a>
                <h3>Editar Atividade</h3>
                <form action="/atividades/{{ atv.id }}/editar" method="POST" class="edit-form">
                    <label>Sequência:</label>
                    <input type="number" name="numero_sequencial" value="{{ atv.numero_sequencial }}" required>
                    
                    <label>Descrição:</label>
                    <input type="text" name="descricao" value="{{ atv.descricao }}" required>
                    
                    <label>Responsável:</label>
                    <select name="responsavel" required>
                        {% for u in usuarios %}
                        <option value="{{ u.username }}" {% if u.username == atv.responsavel %}selected{% endif %}>
                            {{ u.username }}
                        </option>
                        {% endfor %}
                    </select>
                    
                    <button type="submit">Salvar</button>
                    <a href="#" style="text-align:center; margin-top:10px;">Cancelar</a>
                </form>
            </div>
        </div>
        {% endfor %}

    </div>
</body>
</html>
